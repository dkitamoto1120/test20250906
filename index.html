<!DOCTYPE html>
<html lang='ja'>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<title>æŒ¯è¾¼é¡ã‹ã‚‰é€†ç®—ãƒ„ãƒ¼ãƒ«</title>
<style>
:root{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;line-height:1.4;}
body{margin:0;padding:1rem;max-width:480px;margin-inline:auto;}
label,button,select,input{font-size:1rem;min-height:44px;}
fieldset{border:1px solid #ccc;margin-bottom:1rem;padding:0.5rem;}
legend{font-weight:bold;}
input[type='text'],select{width:100%;box-sizing:border-box;}
.row{display:flex;align-items:center;justify-content:space-between;margin:0.25rem 0;padding:0.5rem;border:1px solid #ddd;border-radius:4px;}
.row span.amount{font-weight:bold;}
.copy{margin-left:0.5rem;}
#outputs{margin-top:1rem;}
#outputs .row{background:#f8f8f8;}
button.copy,button#copyAll,button#shareLink{min-width:44px;}
.note{font-size:0.8rem;margin-top:0.5rem;}
footer{margin-top:2rem;font-size:0.7rem;color:#555;}
.test-pass{color:green;}
.test-fail{color:red;}
.error{color:red;}
@media (prefers-color-scheme: dark){
 body{background:#121212;color:#eee;}
 #outputs .row{background:#1e1e1e;border-color:#333;}
 fieldset{border-color:#444;}
}
</style>
</head>
<body>
<h1>æŒ¯è¾¼é¡ã‹ã‚‰é€†ç®—</h1>
<section id='inputs'>
  <label>Candex fee (%)
    <input id='candexFee' type='number' step='0.01' value='3'>
  </label>
  <label><input type='checkbox' id='exemptFlag'>å…ç¨æ¥­è€…ãªã‚‰2%ã«ã‚»ãƒƒãƒˆ</label>
  <fieldset>
    <legend>æ‰‹æ•°æ–™è² æ‹…è€…</legend>
    <label><input type='radio' name='feePayer' value='vendor' checked>Vendorè² æ‹…</label>
    <label><input type='radio' name='feePayer' value='buyer'>Buyerè² æ‹…</label>
  </fieldset>
  <label>You Paid
    <input id='youPaid' type='text' inputmode='numeric' pattern='\d*'>
  </label>
  <label>Vendor Gets
    <input id='vendorGets' type='text' inputmode='numeric' pattern='\d*'>
  </label>
  <input id='net' type='hidden'>
  <div id='netError' class='error' aria-live='polite'></div>
  <fieldset>
    <legend>æºæ³‰åŒºåˆ†</legend>
    <label><input type='radio' name='withhold' value='0'>ãªã—</label>
    <label><input type='radio' name='withhold' value='0.1021' checked>å±…ä½è€…10.21%</label>
    <label><input type='radio' name='withhold' value='0.2042'>éå±…ä½è€…20.42%</label>
  </fieldset>
  <label><input type='checkbox' id='twoStage'>äºŒæ®µéšç¨ç‡(100ä¸‡å††è¶…20.42%)</label>
  <label>æ¶ˆè²»ç¨ç‡
    <select id='taxRate'>
      <option value='0'>0%</option>
      <option value='0.08'>8%</option>
      <option value='0.1' selected>10%</option>
      <option value='custom'>ã‚«ã‚¹ã‚¿ãƒ </option>
    </select>
  </label>
  <label id='customRateLabel' style='display:none'>ã‚«ã‚¹ã‚¿ãƒ ç¨ç‡(%)
    <input id='customRate' type='text' inputmode='numeric' pattern='\d*' value='10'>
  </label>
  <fieldset>
    <legend>æºæ³‰ã®èª²ç¨ãƒ™ãƒ¼ã‚¹</legend>
    <label><input type='radio' name='base' value='fee' checked>ç¨æŠœãƒ™ãƒ¼ã‚¹</label>
    <label><input type='radio' name='base' value='gross'>ç¨è¾¼ãƒ™ãƒ¼ã‚¹</label>
  </fieldset>
  <label>æ¶ˆè²»ç¨ã®ç«¯æ•°å‡¦ç†
    <select id='taxRound'>
      <option value='down' selected>åˆ‡æ¨ã¦</option>
      <option value='nearest'>å››æ¨äº”å…¥</option>
      <option value='up'>åˆ‡ä¸Šã’</option>
    </select>
  </label>
</section>
<section id='outputs'>
  <div class='row'><span>å ±é…¬(ç¨æŠœ)</span><span id='fee' class='amount'>-</span><button class='copy' data-target='fee' aria-label='å ±é…¬ã‚’ã‚³ãƒ”ãƒ¼'>ğŸ“‹</button></div>
  <div class='row'><span>æ¶ˆè²»ç¨</span><span id='tax' class='amount'>-</span><button class='copy' data-target='tax' aria-label='æ¶ˆè²»ç¨ã‚’ã‚³ãƒ”ãƒ¼'>ğŸ“‹</button></div>
  <div class='row'><span>å°è¨ˆ(ç¨è¾¼)</span><span id='gross' class='amount'>-</span><button class='copy' data-target='gross' aria-label='å°è¨ˆã‚’ã‚³ãƒ”ãƒ¼'>ğŸ“‹</button></div>
  <div class='row'><span>æºæ³‰æ‰€å¾—ç¨(â–²)</span><span id='withholding' class='amount'>-</span><button class='copy' data-target='withholding' aria-label='æºæ³‰ç¨ã‚’ã‚³ãƒ”ãƒ¼'>ğŸ“‹</button></div>
  <div class='row'><span>æŒ¯è¾¼é¡</span><span id='netOut' class='amount'>-</span><button class='copy' data-target='netOut' aria-label='æŒ¯è¾¼é¡ã‚’ã‚³ãƒ”ãƒ¼'>ğŸ“‹</button></div>
  <div class='row'><span>ç·æ”¯å‡º(å‚è€ƒ)</span><span id='total' class='amount'>-</span><button class='copy' data-target='total' aria-label='ç·æ”¯å‡ºã‚’ã‚³ãƒ”ãƒ¼'>ğŸ“‹</button></div>
  <button id='copyAll'>æ˜ç´°ã‚’ã‚³ãƒ”ãƒ¼</button>
  <button id='shareLink'>å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼</button>
  <div class='note'>æºæ³‰ç¨ã¯1å††æœªæº€åˆ‡æ¨ã¦ã€‚ç¨è¾¼ï¼ç¨æŠœãƒ™ãƒ¼ã‚¹ã¯è«‹æ±‚æ›¸ã®æ›¸ãæ–¹ã«ä¾å­˜</div>
</section>
<section id='tests'>
  <h2>æ¤œè¨¼</h2>
  <div id='testA'></div>
  <div id='testB'></div>
  <div id='testC'></div>
</section>
<footer>
<p>æœ¬ãƒ„ãƒ¼ãƒ«ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®æ ¹æ‹ :</p>
<ul>
<li>æ¶ˆè²»ç¨ã‚’æ˜ç¢ºåŒºåˆ†ã™ã‚Œã°æºæ³‰å¯¾è±¡ã¯ç¨æŠœã€åŒºåˆ†ã—ãªã„å ´åˆã¯ç¨è¾¼ãŒåŸå‰‡</li>
<li>æºæ³‰10.21%(å±…ä½è€…)ã€éå±…ä½è€…20.42%ã€æºæ³‰ç¨ã¯1å††æœªæº€åˆ‡æ¨ã¦</li>
<li>åŸç¨¿æ–™ãƒ»è¬›æ¼”æ–™ç­‰ã¯100ä¸‡å††è¶…éƒ¨åˆ†20.42%(è©²å½“æ™‚ã®ã¿)</li>
</ul>
<p>å€‹åˆ¥ã®äº‹å®Ÿé–¢ä¿‚ã§çµè«–ãŒç•°ãªã‚‹å ´åˆã‚ã‚Šã€‚æœ€çµ‚åˆ¤æ–­ã¯ç¨å‹™é¡§å•ã¸ã€‚</p>
</footer>
<script>
// å›½ç¨åº: https://www.nta.go.jp/taxes/shiraberu/taxanswer/shohi/6929.htm
// å›½ç¨åº: https://www.nta.go.jp/taxes/shiraberu/taxanswer/gensen/2507.htm
// å›½ç¨åº: https://www.nta.go.jp/taxes/shiraberu/taxanswer/gensen/2884.htm
// å›½ç¨åº: https://www.nta.go.jp/taxes/shiraberu/taxanswer/gensen/2792_qa.htm
const fmt=new Intl.NumberFormat('ja-JP',{style:'currency',currency:'JPY'});
function formatYen(n){return fmt.format(n);}
function toHalf(str){return str.replace(/[ï¼-ï¼™]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0));}
function parseIntFromInput(el){const v=toHalf(el.value.trim());const n=parseInt(v,10);if(isNaN(n)||n<0){return null;}return n;}
let lastEdited='vendor';
let defaultFee=3;
function debounce(fn,delay=300){let t;return(...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),delay);};}
function recalcFrom(src){const you=document.getElementById('youPaid');const vendor=document.getElementById('vendorGets');const net=document.getElementById('net');const round=document.getElementById('taxRound').value;const feeRate=parseFloat(document.getElementById('candexFee').value)/100;const payer=document.querySelector('input[name="feePayer"]:checked').value;if(src==='you'){const y=parseIntFromInput(you);if(y!==null){let v=payer==='vendor'?roundTax(y*(1-feeRate),round):roundTax(y,round);vendor.value=v;net.value=v;}else{vendor.value='';net.value='';}}else if(src==='vendor'){const v=parseIntFromInput(vendor);if(v!==null){let y=payer==='vendor'?roundTax(v/(1-feeRate),round):roundTax(v*(1+feeRate),round);you.value=y;net.value=v;}else{you.value='';net.value='';}}update();}
function roundTax(v,mode){if(mode==='down')return Math.floor(v);if(mode==='up')return Math.ceil(v);return Math.round(v);}
function computeWithholding(base,rate,two){if(rate===0)return 0;if(two){const p1=Math.floor(Math.min(base,1_000_000)*0.1021);const p2=Math.floor(Math.max(base-1_000_000,0)*0.2042);return p1+p2;}return Math.floor(base*rate);}
function netFromFee(fee,params){const tax=roundTax(fee*params.rC,params.round);const gross=fee+tax;const W=computeWithholding(params.base==='fee'?fee:gross,params.rW,params.two);const net=gross-W;return{fee,tax,gross,W,net};}
function netFromGross(gross,params){const W=computeWithholding(gross,params.rW,params.two);const net=gross-W;return{gross,W,net};}
function solveFee(N,params){let lo=0,hi=1_000_000_000,res=null;while(lo<=hi){const mid=Math.floor((lo+hi)/2);const r=netFromFee(mid,params);if(r.net===N){res=r;break;}if(r.net>N)hi=mid-1;else lo=mid+1;}if(!res){const c1=netFromFee(lo,params);const c2=netFromFee(hi,params);res=Math.abs(c1.net-N)<Math.abs(c2.net-N)?c1:c2;}for(let d=-1;d<=1;d++){const c=netFromFee(res.fee+d,params);if(c.net===N){res=c;}}res.total=res.gross;return res;}
function solveGross(N,params){let lo=0,hi=1_000_000_000,res=null;while(lo<=hi){const mid=Math.floor((lo+hi)/2);const r=netFromGross(mid,params);if(r.net===N){res=r;break;}if(r.net>N)hi=mid-1;else lo=mid+1;}if(!res){const c1=netFromGross(lo,params);const c2=netFromGross(hi,params);res=Math.abs(c1.net-N)<Math.abs(c2.net-N)?c1:c2;}for(let d=-1;d<=1;d++){const c=netFromGross(res.gross+d,params);if(c.net===N){res=c;}}const taxBase=params.rC===0?0:res.gross*params.rC/(1+params.rC);const tax=roundTax(taxBase,params.round);const fee=res.gross-tax;res.tax=tax;res.fee=fee;res.total=res.gross;return res;}
function solveNetToInvoice(p){return p.base==='fee'?solveFee(p.N,p):solveGross(p.N,p);}
function buildShareUrl(p){const q=new URLSearchParams();q.set('n',p.N);q.set('w',p.rW);q.set('two',p.two?1:0);q.set('c',p.rC);q.set('base',p.base);q.set('round',p.round);q.set('f',document.getElementById('candexFee').value);q.set('exempt',document.getElementById('exemptFlag').checked?1:0);q.set('fpayer',document.querySelector('input[name="feePayer"]:checked').value);return location.pathname+'?'+q.toString();}
function applyParamsFromQuery(){const q=new URLSearchParams(location.search);if(q.has('f')){const fv=parseFloat(q.get('f'));if(!isNaN(fv)){defaultFee=fv<=1?fv*100:fv;}}document.getElementById('candexFee').value=defaultFee;if(q.get('exempt')==='1'){document.getElementById('exemptFlag').checked=true;document.getElementById('candexFee').value='2';}if(q.has('fpayer')){const fp=document.querySelector(`input[name="feePayer"][value="${q.get('fpayer')}"]`);if(fp)fp.checked=true;}if(q.has('n')){document.getElementById('vendorGets').value=q.get('n');document.getElementById('net').value=q.get('n');}if(q.has('w')){const v=q.get('w');const r=document.querySelector(`input[name="withhold"][value="${v}"]`);if(r)r.checked=true;}if(q.has('two'))document.getElementById('twoStage').checked=q.get('two')==='1';if(q.has('base')){const b=document.querySelector(`input[name="base"][value="${q.get('base')}"]`);if(b)b.checked=true;}if(q.has('round'))document.getElementById('taxRound').value=q.get('round');if(q.has('c')){const c=parseFloat(q.get('c'));const sel=document.getElementById('taxRate');if(c===0||c===0.08||c===0.1){sel.value=c.toString();}else{sel.value='custom';document.getElementById('customRateLabel').style.display='block';document.getElementById('customRate').value=(c*100).toString();}}}
function gatherParams(){const N=parseIntFromInput(document.getElementById('net'));const netErr=document.getElementById('netError');if(N===null){netErr.textContent='æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';return null;}netErr.textContent='';const rW=parseFloat(document.querySelector('input[name="withhold"]:checked').value);const two=document.getElementById('twoStage').checked;const tSel=document.getElementById('taxRate').value;let rC=null;if(tSel==='custom'){const c=parseIntFromInput(document.getElementById('customRate'));if(c===null){return null;}rC=c/100;}else{rC=parseFloat(tSel);}const base=document.querySelector('input[name="base"]:checked').value;const round=document.getElementById('taxRound').value;return{N,rW,rC,base,round,two};}
function update(){const p=gatherParams();if(!p){clearOutputs();return;}const r=solveNetToInvoice(p);document.getElementById('fee').textContent=formatYen(r.fee);document.getElementById('tax').textContent=formatYen(r.tax);document.getElementById('gross').textContent=formatYen(r.gross);document.getElementById('withholding').textContent=formatYen(-r.W);document.getElementById('netOut').textContent=formatYen(r.net);document.getElementById('total').textContent=formatYen(r.total);history.replaceState(null,'',buildShareUrl(p));}
function clearOutputs(){['fee','tax','gross','withholding','netOut','total'].forEach(id=>document.getElementById(id).textContent='-');}
function init(){
  applyParamsFromQuery();
  recalcFrom('vendor');
  document.getElementById('taxRate').addEventListener('change',e=>{
    document.getElementById('customRateLabel').style.display=e.target.value==='custom'?'block':'none';
    update();
  });
  document.querySelectorAll('#inputs input:not(#youPaid):not(#vendorGets):not(#candexFee):not(#exemptFlag):not([name="feePayer"]), #inputs select').forEach(el=>el.addEventListener('input',update));
  document.querySelectorAll('#inputs input[type="radio"]:not([name="feePayer"]), #inputs input[type="checkbox"]:not(#exemptFlag), #inputs select').forEach(el=>el.addEventListener('change',update));
  const you=document.getElementById('youPaid');
  const vendor=document.getElementById('vendorGets');
  const debYou=debounce(()=>recalcFrom('you'),300);
  const debVendor=debounce(()=>recalcFrom('vendor'),300);
  you.addEventListener('input',()=>{lastEdited='you';debYou();});
  vendor.addEventListener('input',()=>{lastEdited='vendor';debVendor();});
  document.getElementById('candexFee').addEventListener('input',()=>recalcFrom(lastEdited));
  document.getElementById('exemptFlag').addEventListener('change',e=>{document.getElementById('candexFee').value=e.target.checked?'2':String(defaultFee);recalcFrom(lastEdited);});
  document.querySelectorAll('input[name="feePayer"]').forEach(r=>r.addEventListener('change',()=>recalcFrom(lastEdited)));
  document.getElementById('taxRound').addEventListener('change',()=>recalcFrom(lastEdited));
  document.querySelectorAll('button.copy').forEach(btn=>btn.addEventListener('click',()=>{
    const t=document.getElementById(btn.dataset.target).textContent;
    navigator.clipboard.writeText(t);
  }));
  document.getElementById('copyAll').addEventListener('click',()=>{
    const lines=[
      `å ±é…¬(ç¨æŠœ): ${document.getElementById('fee').textContent}`,
      `æ¶ˆè²»ç¨: ${document.getElementById('tax').textContent}`,
      `å°è¨ˆ(ç¨è¾¼): ${document.getElementById('gross').textContent}`,
      `æºæ³‰æ‰€å¾—ç¨: ${document.getElementById('withholding').textContent}`,
      `æŒ¯è¾¼é¡: ${document.getElementById('netOut').textContent}`,
      `ç·æ”¯å‡º: ${document.getElementById('total').textContent}`
    ].join('\\n');
    navigator.clipboard.writeText(lines);
  });
  document.getElementById('shareLink').addEventListener('click',()=>{
    navigator.clipboard.writeText(location.href);
  });
  runTests();
}

function runTests(){const tests=[{id:'testA',you:100000,feeRate:0.03,payer:'vendor',expVendor:97000},{id:'testB',vendor:100000,feeRate:0.03,payer:'buyer',expYou:103000}];tests.forEach(t=>{let ok=false;if('you' in t){const v=roundTax(t.you*(1-t.feeRate),'down');ok=v===t.expVendor;}else{const y=roundTax(t.vendor*(1+t.feeRate),'down');ok=y===t.expYou;}const el=document.getElementById(t.id);el.textContent=`${t.id} ${ok?'OK':'NG'}`;el.className=ok?'test-pass':'test-fail';});}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
